{"ast":null,"code":"import _regeneratorRuntime from\"C:/Users/PC/temp/couplove/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"C:/Users/PC/temp/couplove/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"C:/Users/PC/temp/couplove/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{createContext,useState,useRef,useEffect}from'react';import{io}from'socket.io-client';import Peer from'simple-peer';import{jsx as _jsx}from\"react/jsx-runtime\";var SocketContext=/*#__PURE__*/createContext();var ENDPOINT='localhost:5000';var socket;var isCaller=false;var name;var ContextProvider=function ContextProvider(_ref){var children=_ref.children;var _useState=useState(false),_useState2=_slicedToArray(_useState,2),callAccepted=_useState2[0],setCallAccepted=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),callEnded=_useState4[0],setCallEnded=_useState4[1];var _useState5=useState(),_useState6=_slicedToArray(_useState5,2),stream=_useState6[0],setStream=_useState6[1];// const [name, setName] = useState('');\nvar _useState7=useState({}),_useState8=_slicedToArray(_useState7,2),call=_useState8[0],setCall=_useState8[1];var _useState9=useState(''),_useState10=_slicedToArray(_useState9,2),userId=_useState10[0],setUserId=_useState10[1];var _useState11=useState(''),_useState12=_slicedToArray(_useState11,2),roomId=_useState12[0],setRoomId=_useState12[1];var _useState13=useState([]),_useState14=_slicedToArray(_useState13,2),newMessage=_useState14[0],setNewMessage=_useState14[1];var _useState15=useState(),_useState16=_slicedToArray(_useState15,2),partnerId=_useState16[0],setPartnerId=_useState16[1];var _useState17=useState(false),_useState18=_slicedToArray(_useState17,2),isCalling=_useState18[0],setIsCalling=_useState18[1];var _useState19=useState(false),_useState20=_slicedToArray(_useState19,2),noCall=_useState20[0],setNoCall=_useState20[1];var _useState21=useState(true),_useState22=_slicedToArray(_useState21,2),isOnline=_useState22[0],setIsOnline=_useState22[1];var _useState23=useState(),_useState24=_slicedToArray(_useState23,2),users=_useState24[0],setUsers=_useState24[1];var myVideo=useRef();var userVideo=useRef();var connectionRef=useRef();useEffect(function(){socket=io(ENDPOINT);socket.on('chatMsg',function(chat){setNewMessage(chat);});socket.on('startCalling',function(e){callUser();});socket.on('start',function(e){setIsCalling(true);});socket.on('no',function(e){setNoCall(true);alert('your partner is not online!');});},[]);useEffect(function(){if(!isCalling){return null;}socket.on('returnDiv',function(e){document.getElementById('chat-body').style.marginRight=\"auto\";document.getElementById('chat-body').style.marginLeft=\"auto\";document.getElementById(\"video-div\").style.visibility=\"hidden\";});socket.on('calluser',/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(_ref2){var from,callerName,signal;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:from=_ref2.from,callerName=_ref2.name,signal=_ref2.signal;setCall({isReceivingCall:true,from:from,name:callerName,signal:signal});case 2:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref3.apply(this,arguments);};}());socket.on('moveDiv',function(e){document.getElementById('chat-body').style.marginRight=\"auto\";document.getElementById('chat-body').style.marginLeft=\"10px\";document.getElementById(\"video-div\").style.visibility=\"visible\";});socket.on('dc',function(e){leaveCall();});},[isCalling]);// useEffect(()=>{\n//   if(callAccepted)\n//   {\n//     navigator.mediaDevices.getUserMedia({ video: true, audio: true })\n//     .then((currentStream) => {\n//     setStream(currentStream);\n//     myVideo.current.srcObject = currentStream;\n//     });\n//   }\n// },[callAccepted])\nvar startCall=function startCall(){socket.emit('calling');};var joinRoom=function joinRoom(roomId,userId,nickname){socket.emit('join',{userId:userId,roomId:roomId});setUserId(userId);setRoomId(roomId);// setName(nickname); \nname=nickname;};var audio=true;var muteAudio=function muteAudio(){audio=!audio;stream.getAudioTracks()[0].enabled=audio;};var video=true;var muteVideo=function muteVideo(){video=!video;stream.getVideoTracks()[0].enabled=video;};var sendMsg=function sendMsg(msg,nickname){socket.emit('sendMsg',{msg:msg,userId:userId,nickname:nickname,roomId:roomId});};var declineCall=function declineCall(){setCallEnded(true);if(isCaller){document.getElementById('chat-body').style.marginRight=\"auto\";document.getElementById('chat-body').style.marginLeft=\"auto\";document.getElementById(\"video-div\").style.visibility=\"hidden\";}setIsCalling(false);window.location.reload();};var answerCall=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var local,peer;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(function(currentStream){setStream(currentStream);local=currentStream;myVideo.current.srcObject=currentStream;});case 2:setCallAccepted(true);peer=new Peer({initiator:false,trickle:false,stream:local});peer.on('signal',function(data){socket.emit('answercall',{signal:data,to:call.from});});peer.on('stream',function(currentStream){console.log(\"this is the remote stream: \"+currentStream);userVideo.current.srcObject=currentStream;});peer.signal(call.signal);connectionRef.current=peer;case 8:case\"end\":return _context2.stop();}}},_callee2);}));return function answerCall(){return _ref4.apply(this,arguments);};}();var callUser=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var local,peer;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!noCall){_context3.next=2;break;}return _context3.abrupt(\"return\",null);case 2:_context3.next=4;return navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(function(currentStream){setStream(currentStream);local=currentStream;myVideo.current.srcObject=currentStream;});case 4:isCaller=true;peer=new Peer({initiator:true,trickle:false,stream:local});peer.on('signal',function(data){socket.emit('calluser',{signalData:data,name:name});});peer.on('stream',function(currentStream){userVideo.current.srcObject=currentStream;});socket.on('callaccepted',function(signal){console.log('call accepted: '+signal);setCallAccepted(true);peer.signal(signal);});connectionRef.current=peer;case 10:case\"end\":return _context3.stop();}}},_callee3);}));return function callUser(){return _ref5.apply(this,arguments);};}();var leaveCall=function leaveCall(){setCallEnded(true);if(isCaller){document.getElementById('chat-body').style.marginRight=\"auto\";document.getElementById('chat-body').style.marginLeft=\"auto\";document.getElementById(\"video-div\").style.visibility=\"hidden\";}if(connectionRef.current)connectionRef.current.destroy();window.location.reload();};return/*#__PURE__*/_jsx(SocketContext.Provider,{value:{call:call,callAccepted:callAccepted,myVideo:myVideo,newMessage:newMessage,sendMsg:sendMsg,joinRoom:joinRoom,userVideo:userVideo,stream:stream,name:name,callEnded:callEnded,callUser:callUser,leaveCall:leaveCall,answerCall:answerCall,users:users,isOnline:isOnline,startCall:startCall,muteAudio:muteAudio,muteVideo:muteVideo,declineCall:declineCall,isCaller:isCaller},children:children});};export{ContextProvider,SocketContext};","map":{"version":3,"sources":["C:/Users/PC/temp/couplove/client/src/SocketContext.js"],"names":["React","createContext","useState","useRef","useEffect","io","Peer","SocketContext","ENDPOINT","socket","isCaller","name","ContextProvider","children","callAccepted","setCallAccepted","callEnded","setCallEnded","stream","setStream","call","setCall","userId","setUserId","roomId","setRoomId","newMessage","setNewMessage","partnerId","setPartnerId","isCalling","setIsCalling","noCall","setNoCall","isOnline","setIsOnline","users","setUsers","myVideo","userVideo","connectionRef","on","chat","e","callUser","alert","document","getElementById","style","marginRight","marginLeft","visibility","from","callerName","signal","isReceivingCall","leaveCall","startCall","emit","joinRoom","nickname","audio","muteAudio","getAudioTracks","enabled","video","muteVideo","getVideoTracks","sendMsg","msg","declineCall","window","location","reload","answerCall","navigator","mediaDevices","getUserMedia","then","currentStream","local","current","srcObject","peer","initiator","trickle","data","to","console","log","signalData","destroy"],"mappings":"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","sourcesContent":["import React, { createContext, useState, useRef, useEffect } from 'react';\r\nimport { io } from 'socket.io-client';\r\nimport Peer from 'simple-peer';\r\n\r\nconst SocketContext = createContext();\r\n\r\nconst ENDPOINT='localhost:5000';\r\nlet socket;\r\nlet isCaller = false;\r\nlet name ;\r\nconst ContextProvider = ({ children }) => {\r\n  const [callAccepted, setCallAccepted] = useState(false);\r\n  const [callEnded, setCallEnded] = useState(false);\r\n  const [stream, setStream] = useState();\r\n  // const [name, setName] = useState('');\r\n  const [call, setCall] = useState({});\r\n  const [userId,setUserId] = useState('');\r\n  const [roomId,setRoomId] = useState('');\r\n  const [newMessage,setNewMessage] = useState([]);\r\n  const [partnerId,setPartnerId] = useState();\r\n  const [isCalling,setIsCalling] = useState(false);\r\n  const [noCall,setNoCall] = useState(false);\r\n  const [isOnline,setIsOnline] = useState(true);\r\n  const [users,setUsers] = useState();\r\n\r\n  const myVideo = useRef();\r\n  const userVideo = useRef();\r\n  const connectionRef = useRef();\r\n\r\n\r\n   \r\n\r\n  useEffect(() => {\r\n\r\n    socket = io(ENDPOINT);\r\n     \r\n    socket.on('chatMsg',(chat)=>{\r\n        setNewMessage(chat);\r\n    })\r\n\r\n    socket.on('startCalling',e=>{\r\n      callUser();\r\n    })\r\n    socket.on('start',e=>{\r\n      setIsCalling(true);\r\n    })\r\n\r\n    socket.on('no',e=>{\r\n      setNoCall(true);\r\n      alert('your partner is not online!')\r\n    })\r\n  }, []);\r\n\r\n  useEffect(()=>{\r\n    \r\n    \r\n\r\n    if(!isCalling)\r\n    {\r\n      return null;\r\n    }\r\n     \r\n\r\n   socket.on('returnDiv',e=>{\r\n      document.getElementById('chat-body').style.marginRight = \"auto\";\r\n      document.getElementById('chat-body').style.marginLeft = \"auto\";\r\n      document.getElementById(\"video-div\").style.visibility = \"hidden\";\r\n      \r\n   })\r\n\r\n   socket.on('calluser',async ({ from, name: callerName, signal })=> {\r\n    setCall({ isReceivingCall: true, from, name: callerName, signal });\r\n    \r\n  });\r\n\r\n   socket.on('moveDiv',e=>{\r\n    document.getElementById('chat-body').style.marginRight = \"auto\";\r\n    document.getElementById('chat-body').style.marginLeft = \"10px\";\r\n    document.getElementById(\"video-div\").style.visibility = \"visible\";\r\n      \r\n      \r\n   })\r\n\r\n    socket.on('dc',e=>{\r\n      leaveCall();\r\n    })\r\n\r\n  },[isCalling])\r\n\r\n  // useEffect(()=>{\r\n  //   if(callAccepted)\r\n  //   {\r\n  //     navigator.mediaDevices.getUserMedia({ video: true, audio: true })\r\n  //     .then((currentStream) => {\r\n  //     setStream(currentStream);\r\n  //     myVideo.current.srcObject = currentStream;\r\n  //     });\r\n  //   }\r\n  // },[callAccepted])\r\n\r\n  const startCall  =()=>{\r\n    socket.emit('calling');\r\n  }\r\n  \r\n  const joinRoom = (roomId,userId,nickname) =>{\r\n      socket.emit('join',{userId,roomId});\r\n      setUserId(userId);\r\n      setRoomId(roomId);\r\n      // setName(nickname); \r\n      name=nickname;\r\n  }\r\n  let audio =true;\r\n  const muteAudio = ()=>{\r\n    audio  = !audio;\r\n    stream.getAudioTracks()[0].enabled = audio;\r\n  }\r\n\r\n  let video =true;\r\n  const muteVideo = ()=>{\r\n    video  = !video;\r\n    stream.getVideoTracks()[0].enabled = video;\r\n  }\r\n\r\n  const sendMsg = (msg,nickname) =>{\r\n      socket.emit('sendMsg',{msg,userId,nickname,roomId})\r\n  }\r\n\r\n  const declineCall = ()=>{\r\n    setCallEnded(true);\r\n    if(isCaller)\r\n    {\r\n      document.getElementById('chat-body').style.marginRight = \"auto\";\r\n      document.getElementById('chat-body').style.marginLeft = \"auto\";\r\n      document.getElementById(\"video-div\").style.visibility = \"hidden\";\r\n    }\r\n    setIsCalling(false);\r\n    window.location.reload();\r\n  }\r\n\r\n  const answerCall = async() => {\r\n    let local;\r\n    await navigator.mediaDevices.getUserMedia({ video: true, audio: true })\r\n    .then((currentStream) => {\r\n    setStream(currentStream);\r\n    local = currentStream;\r\n    myVideo.current.srcObject = currentStream;\r\n    }); \r\n    setCallAccepted(true);\r\n    const peer = new Peer({ initiator: false, trickle: false, stream:local });\r\n    peer.on('signal', (data) => {\r\n      socket.emit('answercall', { signal: data, to: call.from });\r\n    });\r\n\r\n    peer.on('stream', (currentStream) => {\r\n      console.log(\"this is the remote stream: \" + currentStream);\r\n      userVideo.current.srcObject = currentStream;\r\n    });\r\n\r\n    peer.signal(call.signal);\r\n    connectionRef.current = peer;\r\n  };\r\n\r\n\r\n  const callUser = async() => {\r\n    if(noCall)\r\n    {\r\n      return null;\r\n    }\r\n    let local;\r\n    await navigator.mediaDevices.getUserMedia({ video: true, audio: true })\r\n    .then((currentStream) => {\r\n    setStream(currentStream);\r\n    local = currentStream;\r\n    myVideo.current.srcObject = currentStream;\r\n    }); \r\n    isCaller = true;\r\n    const peer = new Peer({ initiator: true, trickle: false, stream:local });\r\n    peer.on('signal', (data) => {\r\n      socket.emit('calluser', {  signalData: data,  name });\r\n    });\r\n    peer.on('stream', (currentStream) => {\r\n      userVideo.current.srcObject = currentStream;\r\n    });\r\n\r\n    socket.on('callaccepted', (signal) => {\r\n      console.log('call accepted: ' + signal);\r\n      setCallAccepted(true);\r\n      peer.signal(signal);\r\n    });\r\n\r\n    connectionRef.current = peer;\r\n  };\r\n\r\n  const leaveCall = () => {\r\n    setCallEnded(true);\r\n    if(isCaller)\r\n    {\r\n      document.getElementById('chat-body').style.marginRight = \"auto\";\r\n      document.getElementById('chat-body').style.marginLeft = \"auto\";\r\n      document.getElementById(\"video-div\").style.visibility = \"hidden\";\r\n    }\r\n    if(connectionRef.current)connectionRef.current.destroy();\r\n\r\n    window.location.reload();\r\n  };\r\n\r\n  return (\r\n    <SocketContext.Provider value={{\r\n      call,\r\n      callAccepted,\r\n      myVideo,\r\n      newMessage,\r\n      sendMsg,\r\n      joinRoom,\r\n      userVideo,\r\n      stream,\r\n      name,\r\n      callEnded,\r\n      callUser,\r\n      leaveCall,\r\n      answerCall,\r\n      users,\r\n      isOnline,\r\n      startCall,\r\n      muteAudio,\r\n      muteVideo,\r\n      declineCall,\r\n      isCaller,\r\n    }}\r\n    >\r\n      {children}\r\n    </SocketContext.Provider>\r\n  );\r\n};\r\n\r\nexport { ContextProvider, SocketContext };"]},"metadata":{},"sourceType":"module"}