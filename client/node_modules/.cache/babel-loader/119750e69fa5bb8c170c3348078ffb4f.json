{"ast":null,"code":"import _regeneratorRuntime from\"C:/Users/PC/temp/couplove/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"C:/Users/PC/temp/couplove/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _toConsumableArray from\"C:/Users/PC/temp/couplove/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _objectSpread from\"C:/Users/PC/temp/couplove/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _slicedToArray from\"C:/Users/PC/temp/couplove/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{useEffect,useState,useRef,useContext}from'react';import io from'socket.io-client';import axios from'axios';import InputBox from'./InputBox';import'../css/chatroom.css';import ChatNav from'./ChatNav';import ChatBubble from'./ChatBubble';import{Scrollbars}from'react-custom-scrollbars-2';import{SocketContext}from\"../SocketContext\";import VideoRespond from'./VideoRespond';import VideoCall from'./VideoCall';import NavBar from'./Navbar';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export default function ChatRoom(props){var _useState=useState(),_useState2=_slicedToArray(_useState,2),userInfo=_useState2[0],setUserInfo=_useState2[1];var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),userId=_useState4[0],setUserId=_useState4[1];var _useState5=useState(),_useState6=_slicedToArray(_useState5,2),roomId=_useState6[0],setRoomId=_useState6[1];var _useState7=useState(\"\"),_useState8=_slicedToArray(_useState7,2),text=_useState8[0],setText=_useState8[1];var _useState9=useState(),_useState10=_slicedToArray(_useState9,2),userNickname=_useState10[0],setUserNickname=_useState10[1];var _useState11=useState([]),_useState12=_slicedToArray(_useState11,2),messages=_useState12[0],setMessages=_useState12[1];var _useState13=useState([]),_useState14=_slicedToArray(_useState13,2),partnerInfo=_useState14[0],setPartnerInfo=_useState14[1];var _useState15=useState(),_useState16=_slicedToArray(_useState15,2),partnerStatus=_useState16[0],setPartnerStatus=_useState16[1];var _useState17=useState(false),_useState18=_slicedToArray(_useState17,2),havePartner=_useState18[0],setHavePartner=_useState18[1];var _useState19=useState(-1),_useState20=_slicedToArray(_useState19,2),scrollDir=_useState20[0],setScrollDir=_useState20[1];// const [isCalling,setIsCalling] = useState();\nvar _useContext=useContext(SocketContext),joinRoom=_useContext.joinRoom,sendMsg=_useContext.sendMsg,newMessage=_useContext.newMessage,call=_useContext.call,callAccepted=_useContext.callAccepted,startCall=_useContext.startCall;useEffect(function(){var ac=new AbortController();axios.get('/auth/isLoggedIn').then(function(res){return res.data;}).catch(function(err){return console.log(err);}).then(function(res){if(res.isLoggedIn){axios.get('/chat/checkExist').then(res.data).catch(function(err){return console.log(err);}).then(function(res){if(res.data){document.getElementById('msgBox').style.backgroundImage='url(\"/chat/getChatBackground\")';document.getElementById('msgBox').style.backgroundSize='cover';}else{document.getElementById('msgBox').style.backgroundImage='url(\"https://wallpapercave.com/wp/wp4779329.png\")';}});var _userId=res.user._id;var partner=res.user.partner;var nickname=res.user.nickname;setPartnerInfo(res.partnerInfo);if(res.user.partner!==null){setHavePartner(true);axios({method:'get',url:'/user/getRoomId',headers:{'Content-Type':'multipart/form-data'}}).then(function(res){return res.data;}).catch(function(err){return console.log(err);}).then(function(res){setMessages(res.chatInfo.chats.reverse().map(function(chat){return chat;}));var roomId=res.roomInfo._id;setRoomId(roomId);if(nickname){joinRoom(roomId,_userId,nickname);}});}setUserId(res.user._id);setUserInfo(_objectSpread({},res.user));setUserNickname(res.user.nickname);}});return function cancel(){ac.abort();};},[]);useEffect(function(){setMessages(function(prevData){return[].concat(_toConsumableArray(prevData),[newMessage]);});},[newMessage]);useEffect(function(){if(scrollDir===-1){document.getElementById('msgBox').scrollTo(0,document.getElementById('msgBox').scrollHeight);}},[messages]);function handleSendMsg(event){var msg=document.getElementById(\"chat\").value;event.preventDefault();if(msg.length>0&&roomId){sendMsg(msg,userId,userNickname,roomId);setText(\"\");}else{console.log(\"You cant send anything\");}document.getElementById(\"chat\").value=null;}function toggleBackHome(){window.open('/','_self');}function toggleVideoCall(){return _toggleVideoCall.apply(this,arguments);}function _toggleVideoCall(){_toggleVideoCall=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return startCall();case 2:case\"end\":return _context.stop();}}},_callee);}));return _toggleVideoCall.apply(this,arguments);};return/*#__PURE__*/_jsxs(\"div\",{className:\"chat-div\",children:[/*#__PURE__*/_jsx(NavBar,{havePartner:havePartner}),call.isReceivingCall&&!callAccepted&&/*#__PURE__*/_jsx(VideoRespond,{}),/*#__PURE__*/_jsx(VideoCall,{}),/*#__PURE__*/_jsx(\"div\",{className:\"chat-container\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"chat-body\",id:\"chat-body\",children:[/*#__PURE__*/_jsx(ChatNav,{toggleBackHome:toggleBackHome,partnerInfo:partnerInfo,partnerStatus:partnerStatus,toggleVideoCall:toggleVideoCall}),/*#__PURE__*/_jsx(\"div\",{className:\"chat-messageBox-div\",id:\"msgBox\",children:/*#__PURE__*/_jsx(\"div\",{className:\"chat-messageBox\",children:messages&&userInfo&&messages.map(function(chat,index){return/*#__PURE__*/_jsx(ChatBubble,{textInfo:chat,user:userInfo},index);})})}),/*#__PURE__*/_jsx(InputBox,{handleSendMsg:handleSendMsg})]})})]});}","map":{"version":3,"sources":["C:/Users/PC/temp/couplove/client/src/components/ChatRoom.js"],"names":["useEffect","useState","useRef","useContext","io","axios","InputBox","ChatNav","ChatBubble","Scrollbars","SocketContext","VideoRespond","VideoCall","NavBar","ChatRoom","props","userInfo","setUserInfo","userId","setUserId","roomId","setRoomId","text","setText","userNickname","setUserNickname","messages","setMessages","partnerInfo","setPartnerInfo","partnerStatus","setPartnerStatus","havePartner","setHavePartner","scrollDir","setScrollDir","joinRoom","sendMsg","newMessage","call","callAccepted","startCall","ac","AbortController","get","then","res","data","catch","err","console","log","isLoggedIn","document","getElementById","style","backgroundImage","backgroundSize","user","_id","partner","nickname","method","url","headers","chatInfo","chats","reverse","map","chat","roomInfo","cancel","abort","prevData","scrollTo","scrollHeight","handleSendMsg","event","msg","value","preventDefault","length","toggleBackHome","window","open","toggleVideoCall","isReceivingCall","index"],"mappings":"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","sourcesContent":["import {useEffect, useState,useRef, useContext} from 'react';\r\nimport io from 'socket.io-client';\r\nimport axios from 'axios';\r\nimport InputBox from './InputBox';\r\nimport '../css/chatroom.css';\r\nimport ChatNav from './ChatNav';\r\nimport ChatBubble from './ChatBubble';\r\nimport { Scrollbars } from 'react-custom-scrollbars-2';\r\nimport { SocketContext } from \"../SocketContext\";\r\nimport VideoRespond from './VideoRespond';\r\nimport VideoCall from './VideoCall';\r\nimport NavBar from './Navbar';\r\n\r\n\r\nexport default function ChatRoom(props)\r\n{\r\n    const [userInfo,setUserInfo] = useState();\r\n    const [userId,setUserId] = useState();\r\n    const [roomId,setRoomId] = useState();\r\n    const [text,setText] = useState(\"\");\r\n    const [userNickname,setUserNickname] = useState();\r\n    const [messages,setMessages] = useState([]);\r\n    const [partnerInfo,setPartnerInfo] = useState([]);\r\n    const [partnerStatus,setPartnerStatus] = useState();\r\n    const [havePartner,setHavePartner] = useState(false);\r\n    const [scrollDir,setScrollDir] = useState(-1);\r\n\r\n    // const [isCalling,setIsCalling] = useState();\r\n    const {joinRoom,sendMsg,newMessage,call,callAccepted,startCall} = useContext(SocketContext);\r\n\r\n    useEffect(()=>{\r\n        const ac = new AbortController();\r\n        axios.get('/auth/isLoggedIn')\r\n        .then(res =>res.data)\r\n        .catch(err => console.log(err))\r\n        .then(res => {\r\n            if(res.isLoggedIn)\r\n            {\r\n              axios.get('/chat/checkExist')\r\n              .then(res.data)\r\n              .catch(err=>console.log(err))\r\n              .then(res=>{\r\n                if(res.data)\r\n                {\r\n                  document.getElementById('msgBox').style.backgroundImage ='url(\"/chat/getChatBackground\")';\r\n                  document.getElementById('msgBox').style.backgroundSize ='cover';\r\n                }\r\n                else\r\n                {\r\n                  document.getElementById('msgBox').style.backgroundImage = 'url(\"https://wallpapercave.com/wp/wp4779329.png\")';\r\n                }\r\n              })\r\n              \r\n              let userId = res.user._id;\r\n              let partner = res.user.partner;\r\n              let nickname = res.user.nickname;\r\n              setPartnerInfo(res.partnerInfo)\r\n                if(res.user.partner!==null)\r\n                { \r\n                  setHavePartner(true);\r\n                  axios({ \r\n                    method:'get',\r\n                    url:'/user/getRoomId',\r\n                    headers: {'Content-Type': 'multipart/form-data'}\r\n                  })\r\n                  .then(res=>res.data)\r\n                  .catch(err=>console.log(err))\r\n                  .then(res=>{\r\n                    setMessages(res.chatInfo.chats.reverse().map(chat=>{\r\n                      return chat;\r\n                    }))\r\n                    let roomId = res.roomInfo._id;\r\n                    setRoomId(roomId);\r\n                    if(nickname)\r\n                    {\r\n                       joinRoom(roomId,userId,nickname);  \r\n                    }\r\n                  })\r\n                }\r\n                setUserId(res.user._id);\r\n                setUserInfo({...res.user});\r\n                setUserNickname(res.user.nickname);\r\n            }\r\n        });\r\n        return function cancel() {\r\n            ac.abort();\r\n          }\r\n    },[])\r\n\r\n    useEffect(()=>{\r\n      setMessages(prevData=>{\r\n        return[...prevData,newMessage]\r\n      })\r\n    },[newMessage]);\r\n    useEffect(()=>{\r\n      if(scrollDir===-1)\r\n      {\r\n        document.getElementById('msgBox').scrollTo(0,document.getElementById('msgBox').scrollHeight);      \r\n      }\r\n    },[messages])\r\n    \r\n    function handleSendMsg(event)\r\n    {\r\n      let msg = document.getElementById(\"chat\").value;\r\n      event.preventDefault();\r\n      if(msg.length>0&&roomId)\r\n      {\r\n        sendMsg(msg,userId,userNickname,roomId);\r\n        setText(\"\");\r\n      }\r\n      else{\r\n        console.log(\"You cant send anything\")\r\n      }\r\n      document.getElementById(\"chat\").value = null;\r\n    }\r\n\r\n    function toggleBackHome()\r\n    {\r\n      window.open('/','_self');\r\n    }\r\n\r\n    async function toggleVideoCall()\r\n    {\r\n      await startCall();\r\n      // await callUser();\r\n    };\r\n\r\n\r\n    return<div className=\"chat-div\">\r\n      <NavBar havePartner={havePartner}/>\r\n        {call.isReceivingCall &&!callAccepted&&<VideoRespond/>}\r\n     <VideoCall/>\r\n     <div className=\"chat-container\">\r\n     <div className=\"chat-body\" id=\"chat-body\">\r\n     <ChatNav  toggleBackHome={toggleBackHome} partnerInfo={partnerInfo} partnerStatus={partnerStatus} toggleVideoCall={toggleVideoCall}/>\r\n    <div className=\"chat-messageBox-div\" id=\"msgBox\">\r\n        <div className=\"chat-messageBox\">\r\n      {messages&&userInfo&&messages.map((chat,index)=>{\r\n              return <ChatBubble key={index}textInfo={chat} user={userInfo}/>\r\n      })} \r\n       </div>\r\n    </div>\r\n    <InputBox handleSendMsg={handleSendMsg}/>\r\n     </div>\r\n     </div>\r\n  </div>\r\n}"]},"metadata":{},"sourceType":"module"}